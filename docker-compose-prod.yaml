version: '3.7'

services:
    php:
        volumes:
            - php-public:/srv/api/public:rw,cached
            - php-uploads:/srv/api/var/uploads:rw,cached
            - jwt-keys:/srv/api/config/jwt
        env_file:
            - ./shared/.env.prod.local
            - ./api/.env.prod.local

    nginx:
        volumes:
            - php-public:/srv/api/public:ro,cached
        env_file:
            - ./shared/.env.prod.local

    varnish:
        networks:
            - traefik_traefik
        labels:
            - "traefik.enable=true"
            - "traefik.api.port=80"
            - "traefik.api.protocol=http"
            - "traefik.api.frontend.rule=Host:${API_HOST}"

    smtp_relay:
        environment:
            MAILNAME: ${APP_HOST}

    db:
        volumes:
            - mysql-data:/var/lib/mysql:rw,delegated
        env_file:
            - ./shared/.env.prod.local

    app:
        networks:
            - traefik_traefik
        env_file:
            - ./shared/.env.prod.local
            - ./app/_docker/.env.prod.local
        labels:
            - "traefik.enable=true"
            - "traefik.app.frontend.rule=Host:${APP_HOST}"
            - "traefik.app.port=3000"
            - "traefik.app.protocol=http"

#    admin:
#        env_file:
#            - ./admin/.env.prod.local
#        networks:
#            - traefik_traefik
#        labels:
#            - "traefik.enable=true"
#            - "traefik.app.port=3000"
#            - "traefik.app.protocol=http"
#            - "traefik.app.frontend.rule=Host:admin.website.com"

networks:
    traefik_traefik:
        external: true

volumes:
    php-public:
    php-uploads:
    jwt-keys:
    mysql-data:

